matrix:
  include:
    - os: linux
      sudo: false
      language: node_js
      node_js: 10
    - os: osx
      language: node_js
      node_js: 10

env:
  global:
    - SCROLEX_MODE=passthru
    - secure: BeM6mpPEATdeFcAr/222QBZ9vRkZtU2WOi9QQy3mxsuDbWfM8RxYESIEJLipyhW9kXGoe6HGMqm4Kz9B/c4jrzeSXPpKnW7mIfnyqN+hhq1ctW9qPSqodu+fYNhdDxXh5wylml7hnIJzU70vFGrFknZRE2FYk5XvyHg2ImIKDJw=
    - secure: RJ5UpdXms9QkraylZ11OBfmcRrmKnb254Yj0yCDAvZmg+n+3jSTwMgGvPY8Ih8X/R1JeW3VTtFDkJXXPnjjfpNg1M91u4CAEUOMPciCudYcoF6GKb8psnOzneTTX5M7zuJSzknGdpv/foldxiPYxiY5Hn5bfjmikhAEl+QX/R0Y=
    - secure: BXf2buPt/DA09M5ZUdp/LpOWtUuz1mfCBopLyxvHv3Sl3ln+Az57wWsM2+Re+77lUOgihR2f6lXYfNUmQuSUo157rZPunQCqM/DJhK69KhREEB6SJDaJF3FVlnGla+Cwwb1IQUtMopqX9pBYD7w/zyWQFJCi20O57JEVIdfZZS8=
    - secure: AaDI3OLTcwau2tu9jTtR0eHpylSUudYua9aKH3C540Lm2scQhQcT4IbMa6KXgrY+1UchapS9gUuClH8QwgJo61tJjtOqvmCgZ2EkmZg68pzw/25zwv7LSzYASbZvKahulV/giZdxFLGOpPhNhKbG70/owYXjKFENi5LoZKc8Y+c=

addons:
  apt:
    update: true
    packages:
      - xz-utils
  homebrew:
    update: true
    packages:
      - coreutils
      - gnu-sed
      - gnu-tar
      - grep
      - gawk
      - findutils
      # - gnu-indent
      # - gnutls

git:
  depth: 3

before_install:
  - |
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      if type brew &>/dev/null; then
        HOMEBREW_PREFIX=$(brew --prefix)
        # gnubin;
        for d in ${HOMEBREW_PREFIX}/opt/*/libexec/gnubin; do export PATH=$d:$PATH; done
        # gnuman
        # for d in ${HOMEBREW_PREFIX}/opt/*/libexec/gnuman; do export MANPATH=$d:$MANPATH; done
      fi
    fi
  - |
    echo ######################################
    echo "Testing GNU binaries"
    sha512sum --version || true
    tar --version|| true
    install --version || true
    grep --version || true
    sed --version || true
    find --version || true
    date --version || true
    make --version || true
    echo ######################################
    echo
  - |
    sc_version="latest" # or "v0.7.0", or "stable"
    if [ "$TRAVIS_OS_NAME" = "linux" ]; then sc_arch="linux";  fi
    if [ "$TRAVIS_OS_NAME" = "osx"   ]; then sc_arch="darwin"; fi
    if type shellcheck &>/dev/null; then
      sc_bin="$(type -P shellcheck)"
    else
      sc_bin=/usr/bin/shellcheck
    fi

    sc_tmp="$(mktemp -d)" && pushd "${sc_tmp}" > /dev/null || return
    curl -k -sSLO "https://storage.googleapis.com/shellcheck/shellcheck-${sc_version?}.${sc_arch}.x86_64.tar.xz"
    curl -k -sSLO "https://storage.googleapis.com/shellcheck/shellcheck-${sc_version?}.${sc_arch}.x86_64.tar.xz.sha512sum"
    if sha512sum -c --quiet "shellcheck-${sc_version?}.${sc_arch}.x86_64.tar.xz.sha512sum"; then
      tar -x --xz -f "shellcheck-${sc_version?}.${sc_arch}.x86_64.tar.xz"
      sudo install -v -m0755 "${sc_tmp}/shellcheck-${sc_version}/shellcheck" "$sc_bin"
      echo ######################################
      grep 'binary was compiled' "${sc_tmp}/shellcheck-${sc_version}/README.txt"
      "$sc_bin" --version || shellcheck --version  || true
    fi
    popd > /dev/null || return
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then type -P bundle || gem install bundler; fi


before_script:
  - bash --version
  - awk --version

before_cache:
  - rm -f ./node_modules/.bin/which
  # cache:
  #   apt: true
  #   directories:
  #   - .lanyon

script: test/acceptance.sh

deploy:
  skip_cleanup: true
  provider: script
  script: ./node_modules/lanyon/scripts/ci-deploy.sh
  on:
    branch: master
    condition: $TRAVIS_OS_NAME = linux
